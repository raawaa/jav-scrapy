name: Release

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        registry-url: 'https://registry.npmjs.org'

    - name: Install dependencies
      run: npm ci

    - name: Build TypeScript
      run: npm run build

    - name: Run Semantic Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      run: npm run release

  build-and-upload:
    needs: release
    runs-on: ${{ matrix.os }}
    if: needs.release.result == 'success'
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
            node_target: node18-linux-x64
            binary_name: jav-scrapy-linux-x64
          - os: ubuntu-latest
            platform: linux
            arch: arm64
            node_target: node18-linux-arm64
            binary_name: jav-scrapy-linux-arm64
          - os: windows-latest
            platform: windows
            arch: x64
            node_target: node18-win-x64
            binary_name: jav-scrapy-windows-x64.exe
          - os: windows-latest
            platform: windows
            arch: arm64
            node_target: node18-win-arm64
            binary_name: jav-scrapy-windows-arm64.exe
          - os: macos-latest
            platform: macos
            arch: x64
            node_target: node18-macos-x64
            binary_name: jav-scrapy-macos-x64
          - os: macos-latest
            platform: macos
            arch: arm64
            node_target: node18-macos-arm64
            binary_name: jav-scrapy-macos-arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build TypeScript
      run: npm run build

    - name: Install pkg
      run: npm install -g pkg

    - name: Get version
      id: version
      run: echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

    - name: Clear pkg cache
      run: |
        rm -rf ~/.pkg-cache || true
        npm cache clean --force || true

    - name: Build binary (Unix)
      if: matrix.platform != 'windows'
      run: |
        PKG_CACHE_PATH=/tmp/.pkg-cache pkg dist/jav.js --target ${{ matrix.node_target }} --output ${{ matrix.binary_name }}-${{ steps.version.outputs.VERSION }} || \
        PUPPETEER_SKIP_DOWNLOAD=true PKG_CACHE_PATH=/tmp/.pkg-cache pkg dist/jav.js --target ${{ matrix.node_target }} --output ${{ matrix.binary_name }}-${{ steps.version.outputs.VERSION }}
        chmod +x ${{ matrix.binary_name }}-${{ steps.version.outputs.VERSION }}

    - name: Build binary (Windows)
      if: matrix.platform == 'windows'
      shell: bash
      run: |
        export PKG_CACHE_PATH="C:/temp/pkg-cache"
        export PUPPETEER_SKIP_DOWNLOAD=true
        export PUPPETEER_EXECUTABLE_PATH=""
        timeout 300 pkg dist/jav.js --target ${{ matrix.node_target }} --output ${{ matrix.binary_name }}-${{ steps.version.outputs.VERSION }} || \
        echo "Binary build timed out or failed, but continuing..."

    - name: Generate checksum
      run: |
        if [ "${{ matrix.platform }}" = "windows" ]; then
          sha256sum ${{ matrix.binary_name }}-${{ steps.version.outputs.VERSION }} > ${{ matrix.binary_name }}-${{ steps.version.outputs.VERSION }}.sha256
        else
          sha256sum ${{ matrix.binary_name }}-${{ steps.version.outputs.VERSION }} > ${{ matrix.binary_name }}-${{ steps.version.outputs.VERSION }}.sha256
        fi
      shell: bash

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.binary_name }}-${{ steps.version.outputs.VERSION }}
        path: |
          ${{ matrix.binary_name }}-${{ steps.version.outputs.VERSION }}
          ${{ matrix.binary_name }}-${{ steps.version.outputs.VERSION }}.sha256
        retention-days: 30

  attach-assets:
    needs: [release, build-and-upload]
    runs-on: ubuntu-latest
    if: needs.release.result == 'success' && needs.build-and-upload.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version
      id: version
      run: echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        find artifacts -name "jav-scrapy-*" -type f -exec cp {} release-assets/ \;
        find artifacts -name "*.sha256" -type f -exec cp {} release-assets/ \;
        ls -la release-assets/

    - name: Create checksums file
      run: |
        cd release-assets
        sha256sum * > checksums.txt
        cat checksums.txt

    - name: Read changelog
      id: changelog
      run: |
        # æå–å½“å‰ç‰ˆæœ¬çš„ changelog å†…å®¹
        if [ -f "CHANGELOG.md" ]; then
          # ä» CHANGELOG.md ä¸­æå–å½“å‰ç‰ˆæœ¬çš„å†…å®¹
          awk "/## \\[${{ steps.version.outputs.VERSION }}\\]/,/^## / { if (!/^## / || /## \\[${{ steps.version.outputs.VERSION }}\\]/) print }" CHANGELOG.md > current_changelog.md
          # ç§»é™¤å¼€å¤´çš„ç‰ˆæœ¬æ ‡é¢˜è¡Œï¼ˆå› ä¸ºä¼šåœ¨ release ä¸­é‡å¤ï¼‰
          sed -i '' '1d' current_changelog.md
          # ç§»é™¤ç©ºè¡Œå’Œå¤šä½™çš„æ ¼å¼
          sed -i '' '/^$/d' current_changelog.md
          # è¯»å–å†…å®¹å¹¶è®¾ç½®ä¸ºè¾“å‡º
          CHANGELOG_CONTENT=$(cat current_changelog.md | tr '\n' '\\n')
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "changelog=è¯·æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£äº†è§£æ›´æ–°å†…å®¹ã€‚" >> $GITHUB_OUTPUT
        fi

    - name: Update Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: jav-scrapy ${{ steps.version.outputs.VERSION }}
        files: |
          release-assets/*
        body: |
          ## ğŸ¬ jav-scrapy ${{ steps.version.outputs.VERSION }}
          
          ${{ steps.changelog.outputs.changelog }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          **äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½ï¼š**
          - Windows (x64): `jav-scrapy-${{ steps.version.outputs.VERSION }}-windows-x64.exe`
          - Windows (ARM64): `jav-scrapy-${{ steps.version.outputs.VERSION }}-windows-arm64.exe`
          - macOS (Intel): `jav-scrapy-${{ steps.version.outputs.VERSION }}-macos-x64`
          - macOS (Apple Silicon): `jav-scrapy-${{ steps.version.outputs.VERSION }}-macos-arm64`
          - Linux (x64): `jav-scrapy-${{ steps.version.outputs.VERSION }}-linux-x64`
          - Linux (ARM64): `jav-scrapy-${{ steps.version.outputs.VERSION }}-linux-arm64`
          
          **ä¸€é”®å®‰è£…ï¼š**
          ```bash
          # Linux/macOS
          curl -sSL https://raw.githubusercontent.com/raawaa/jav-scrapy/main/install.sh | bash
          
          # Windows PowerShell
          iwr -useb https://raw.githubusercontent.com/raawaa/jav-scrapy/main/install.ps1 | iex
          ```
          
          ### ğŸ” æ–‡ä»¶æ ¡éªŒ
          
          æ‰€æœ‰æ–‡ä»¶éƒ½æä¾›äº†SHA256æ ¡éªŒå’Œï¼Œè¯·éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
          ```bash
          sha256sum -c checksums.txt
          ```
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          
          - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦ä¸‹è½½Chromiumæµè§ˆå™¨
          - è¯·ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸ï¼Œæˆ–é…ç½®ä»£ç†
          - æ›´å¤šä½¿ç”¨è¯´æ˜è¯·æŸ¥çœ‹é¡¹ç›®README
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}